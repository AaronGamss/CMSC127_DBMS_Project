<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Balik UP Min My Reports</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body>
    <nav class="navbar fixed-top" style="background-color: #EAE8E5">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="home.html">
                BALIK UP MIN
                <img src="logo.png" alt="Logo" width="30" height="30" class="ms-2" />
            </a>
            <ul class="navbar-nav d-flex flex-row gap-5 ms-auto me-5">
                <li class="nav-item">
                    <a class="nav-link" href="home.html">home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="lost.html">lost</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="found.html">found</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="report.html">report</a>
                </li>
            </ul>
            <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar"
            >
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
            <div
                class="offcanvas offcanvas-end"
                tabindex="-1"
                id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel"
                style="background-color: #333333; color: #EAE8E5;"
            >
                <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="email-display" style="font-weight: 700; font-size: 1.4rem; margin-bottom: 0px; margin-top: 10px;">
                    Email
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="offcanvas"
                    aria-label="Close"
                    style="filter: invert(1); margin-top: 8px;"
                ></button>
                </div>
                <hr style="border: 1px solid #EAE8E5; opacity: 0.5; width: 100%; margin-bottom: 0px;" />
                <div class="offcanvas-body">
                <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                    <li class="nav-item mb-3">
                    <a class="nav-link" href="myreports.html" style="color: #EAE8E5; font-weight: 600;">
                        My Reports
                    </a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" href="#" id="logout-btn" style="color: #EAE8E5; font-weight: 600;">
                        Sign Out
                    </a>
                    </li>
                </ul>
                </div>
            </div>
        </div>
    </nav>
        <!-- My reports-->
         
        <main class="container mt-5 pt-5">
            <!-- Header -->
            <div class="listing-header">
              <div>
                <h1 class="fw-bold mb-1" style="font-size: 3.0rem;">My Reports</h1>
                <p class="small text-muted">search results...</p>
              </div>

            <!-- Search Bar-->
            <div class="search-container">
                <div class="search-bar d-flex align-items-center" style="box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
                  <i class="bi bi-search me-2"></i>
                  <input type="text" id="search-bar" class="form-control" placeholder="Search by item, location, or reporter...">
                  <button class="btn btn-link p-0 ms-2">
                  <i class="bi bi-list fs-5"></i>
                  </button>
                </div>
              </div>
            </div>
            <br>
            
              <!-- No reports message -->
              <div class="emp-reports-container">
                <div class="d-flex justify-content-center align-items-center ">
                    <div class="card text-center p-4 shadow" style="width: 840px; height: 417px;">
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="bi bi-exclamation-triangle-fill" style="font-size: 5rem;"></i>
                            </div>
                            <h4 class="card-title mb-2" style="font-size: 2rem; font-weight: 650;">Empty!</h4>
                            <p class="card-text mb-4 mx-auto" style="width: 30%;">please click below to report a lost or found item</p>
                            <a class="btn btn-light" href="report.html" style="background-color: #333333; color: #ffff; width: 23%; font-weight: 650;">Report</a>
                        </div>
                    </div>
                </div>
            </div>
            
              <!-- Item Report cards -->

                       
              <div class="d-flex flex-column gap-3 mt-4" id="listingContainer">
                <!-- Example Item Cards 
                 Example Item Cards
                <div class="listing-card item-card">
                  <div class="image-placeholder">
                    <img src="https://images.unsplash.com/photo-1678685888221-cda773a3dcdb?fm=jpg&q=60&w=3000&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8YXBwbGUlMjBpcGhvbmV8ZW58MHx8MHx8fDA%3D" alt="Item" class="img-fluid rounded" style="height: 100%; width: 100%; object-fit: contain;" />
                  </div>
                  <div class="flex-grow-1">
                    <p class="item-name" style="font-weight: bold; margin-bottom: 66px; margin-top: 20px;">Item Name: Cellphone</p>
                    <p class="item-status" style="margin-bottom: 66px;">Status: Lost</p>
                    <p class="item-location" style="margin-bottom: 66px;">Location: CHSS Lobby</p>
                    <p style="margin-bottom: 20px;">Date: April 26, 2025</p>
                    <a href="#" class="btn btn-sm btn-secondary" style="background-color: #0000;">Resolve</a>
                  </div>
                </div> 
  
                <div class="listing-card item-card">
                    <div class="d-flex">
                        <div class="image-placeholder">
                          <img
                            src="https://media.karousell.com/media/photos/products/2024/4/9/used_high_quality_yonex_carbon_1712658302_72da5535_progressive.jpg"
                            alt="Item"
                            class="img-fluid rounded"
                            style="height: 100%; width: 100%; object-fit: contain;"
                          />
                        </div>
                      
                        <div class="flex-grow-1">
                          <p class="item-name" style="font-weight: bold; margin-bottom: 66px; margin-top: 20px;">Item Name: Badminton Racket</p>
                          <p class="item-status" style="margin-bottom: 66px;">Status: Found</p>
                          <p class="item-location" style="margin-bottom: 66px;">Location: CHSS Lobby</p>
                          <p style="margin-bottom: 20px;">Date: April 26, 2025</p> -->
                      
                          <!-- Resolve Button (triggers modal) 
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#resolveModal">
                            Resolve
                          </button>
                        </div>
                      </div> -->
                      

                      

  

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
        
        
        <!--NOTE TO BACKEND:
  
            - .item-card
            - .item-name
            - .item-status
            - .item-location

        -->
    
       <script>
        const searchBar = document.getElementById("search-bar");

        searchBar.addEventListener("input", () => {
            const itemCards = document.querySelectorAll(".item-card");
            const listingContainer = document.getElementById("listingContainer");
            const term = searchBar.value.toLowerCase();
            let foundAny = false;
        
            itemCards.forEach((card) => {
                const name = card.querySelector(".item-name")?.textContent.toLowerCase() || "";
                const location = card.querySelector(".item-location")?.textContent.replace("Location:", "").trim().toLowerCase() || "";
                const status = card.querySelector(".item-status")?.textContent.replace("Status:", "").trim().toLowerCase() || "";
        
                const matches = name.includes(term) || location.includes(term) || status.includes(term);
        
                if (matches) {
                    card.classList.remove("d-none");
                    foundAny = true;
                } else {
                    card.classList.add("d-none");
                }
            });
        
            // Check if "no results" message already exists
            let noResults = document.getElementById("no-results");
        
            if (!foundAny) {
                if (!noResults) {
                    noResults = document.createElement("p");
                    noResults.id = "no-results";
                    noResults.className = "text-muted text-center mt-3";
                    noResults.textContent = "No matching results.";
                    listingContainer.appendChild(noResults);
                }
            } else {
                if (noResults) {
                    noResults.remove();
                }
            }
        });
    </script>

      <!--script to fetch the email of the user -->
      <script type="module">
        import { supabase } from './supabaseClient.js'; // Make sure your supabaseClient.js is properly linked
    
        // Check if access token exists
        const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
    
        if (!token) {
            window.location.href = 'login.html'; // If no token, force to login
        }
    
        // Fetch the user session
        async function fetchUser() {
            const { data: { session }, error } = await supabase.auth.getSession();
    
            if (error) {
                console.error("Error fetching session:", error);
                return;
            }
    
            if (session && session.user) {
                const email = session.user.email;
                const emailDisplay = document.getElementById('email-display');
                if (emailDisplay) {
                    emailDisplay.textContent = email;
                }
            } else {
                console.error("No user session found.");
                window.location.href = 'login.html'; 
            }
        }
    
        fetchUser(); // Always fetch on page load
    
        // Logout functionality
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                localStorage.removeItem('access_token');
                sessionStorage.removeItem('access_token');
                window.location.href = 'login.html';
            });
        }

        // Fetch the LocationName attribute from CampusLocation table using LocationID foreign key
        async function fetchLocationName(locationId) {
            const { data, error } = await supabase
                .from('CampusLocation')
                .select('LocationName')
                .eq('LocationID', locationId)
                .single();

            if (error) {
                console.error('Error fetching location name:', error);
                return 'Unknown Location';
            }

            return data ? data.LocationName : 'Unknown Location';
        }

        async function fetchUserReports() {
            // Get the auth user
            const { data: { user: authUser } } = await supabase.auth.getUser();
                if (!authUser) {
                    console.error('No user logged in');
                    return;
                }

            // Look up the numeric UserID in your User table
            const { data: userProfile, error: profileErr} = await supabase
                .from('User')
                .select('UserID')
                .eq('Email', authUser.email)
                .single();

            // Handle lookup errors immediately
            if (profileErr || !userProfile) {
                console.error('Could not find numeric UserID for', authUser.email, profileErr);
                return;
            }

            const numericUserId = userProfile.UserID;

            // Fetch the lost item reports submitted by the current user
            const { data: lostReports, error: lostReportsError } = await supabase
                .from('LostItem')
                .select('*')
                .eq('UserID', numericUserId);

            if (lostReportsError) {
                console.error('Error fetching lost item reports:', lostReportsError);
                return;
            }

            // Fetch the found item reports submitted by the current user
            const { data: foundReports, error: foundReportsError } = await supabase
                .from('FoundItem')
                .select('*')
                .eq('UserID', numericUserId);

            if (foundReportsError) {
                console.error('Error fetching found item reports:', foundReportsError);
                return;
            }

            // Combine the reports from both tables into a single array
            const userReports = [...(lostReports || []), ...(foundReports || [])];

            // const listingContainer = document.getElementById('listingContainer'); already exists above\
            const empReportsContainer = document.querySelector('.emp-reports-container');

            // Shows and hides the listing and no reports containers
            if (userReports.length === 0) {
                listingContainer.style.display = 'none';
                empReportsContainer.style.display = 'block';
            } else {
                listingContainer.style.display = 'block';
                empReportsContainer.style.display = 'none';
            }

            listingContainer.innerHTML = '';
            userReports.forEach(async (report) => {
                const locationName = await fetchLocationName(report.LocationID);
                const date = report.DateLost || report.DateFound || 'Unknown Date';
                const card = document.createElement('div');
                card.className = 'listing-card item-card';
                card.innerHTML = `
                    <div class="image-placeholder">
                        <img src="${report.Image || 'logo.png'}" alt="Item" class="img-fluid rounded" style="height: 100%; width: 100%; object-fit: contain;" />
                    </div>
                    <div class="flex-grow-1">
                        <p class="item-name" style="font-weight: bold; margin-bottom: 66px; margin-top: 20px;">Item Name: ${report.Name}</p>
                        <p class="item-status" style="margin-bottom: 66px;">Status: ${report.Status}</p>
                        <p class="item-location" style="margin-bottom: 66px;">Location: ${locationName}</p>
                        <p style="margin-bottom: 20px;">Date: ${date}</p>
                        <button type="button" class="btn btn-sm btn-secondary resolve-btn d-flex justify-content-center align-items-center" style="background-color: #000000; border-radius: 8px; font-weight: 650; height: 40px; margin-top: auto; " 
                                data-bs-toggle="modal" 
                                data-bs-target="#resolveModal">
                
                            Resolve
                        </button>
                        

                    <!-- Resolve Modal -->
                      <div class="modal fade" id="resolveModal" tabindex="-1" aria-labelledby="resolveModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="resolveModalLabel">Confirm Resolve</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              Are you sure you want to mark this item as resolved?
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-tertiary border border-secondary"  data-bs-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-primary confirm-resolve-btn border border-secondary" data-id="${report.ID}" style="background-color: #988F78;">Yes, Resolve</button>
                            </div>
                          </div>
                        </div>
                      </div>


                    </div>`;
                listingContainer.appendChild(card);
            });
        }

        fetchUserReports(); // Fetch user reports on page load
      </script>


      <script>
    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('confirm-resolve-btn')) {
            // Find the closest card to the clicked button
            const card = event.target.closest('.item-card');

            // Update the card visually
            card.style.backgroundColor = '#d3d3d3';
            card.querySelector('.item-status').textContent = 'Status: Resolved'; // Update status text
            const resolveButton = card.querySelector('.resolve-btn');
            if (resolveButton) {
                resolveButton.remove(); // Remove the "Resolve" button

            const modal = event.target.closest('.modal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            bootstrapModal.hide();    
            }

        }
    });
</script>

      
</body>
</html>
